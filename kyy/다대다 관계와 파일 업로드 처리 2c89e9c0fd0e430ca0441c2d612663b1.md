# 다대다 관계와 파일 업로드 처리

## 정리

- 다대다 관계 문제를 알아보고 JPA에서 어떻게 푸는지 사용방법 익히기
- N+1 문제 및 해결방법

## 선행학습

- 객체와 테이블 연관관계의 차이
- 객체의 참조와 테이블의 외래 키를 매핑
- 용어
    - 방향: 단방향, 양방향
    - 다중성: 다대일, 일대다, 일대일, 다대다
    - 연관관계의 주인: 객체 양방향 연관관계는 관리
1. M:N 관계의 설계와 구현
    1. 예제
        1. 영화와 회원이 존재하고 회원이 영화에 대한 평점과 감상을 기록하는 시나리오를 기반으로 프로젝트가 구성됨.
    2. 명제
        1. 한편의 영화는 여러 회원의 평가가 행해질 수 있다.
        2. 한 명의 회원은 여러 영화에 대해서 평점을 줄 수 있다. 
    3. 다대다 관계의 특징
        1. 논리적 설계와 실제 테이블 설계가 다르다. 
        2. 엔티티 : 영화, 회원, 대부분은 엔티티는 명사가 많다. 
        3. 회원 입장에서 보면 여러편의 영화를 평가한다. 
        4. 한편의 영화는 여러 회원이 존재한다. 
    4. 실제 개념적으로 다대다를 사용하는 케이스
        1. 학생과 수업의 관계 
            1. 한 명의 학생은 여러 수업에 참여하고, 하나의 수업은 여러 학생이 수강한다.
        2. 상품과 상품 카테고리 
            1. 하나의 상품은 여러 카테고리에 속하고, 하나의 카테고리는 여러 상품을 가지고 있다.
        3. 상품과 회원의 관계 
            1. 하나의 상품은 여러 회원이 구매할 수 있고, 한 명의 회원은 여러 상품을 구매 할 수 있다.
    5. 문제
        1. 다대다의 관계를 실제 테이블로 설계할 수가 없다는 것 테이블은 고정된 개수의 칼럼을 가지고 있기 때문
        
        | 상품번호 | 상품명 |
        | --- | --- |
        | 1 | 냉장고 |
        | 2 | 세탁기 |
        
        | 카테고리 | 설명 |
        | --- | --- |
        | C1 | 가전 |
        | C2 | 신혼 |
        
        | 상품번호 | 상품명 | 상품 카테고리 |
        | --- | --- | --- |
        | 1 | 냉장고 | C1, C2, C3 |
        | 2 | 세탁기 | C1, C2 |
        
        그림에서는 ,를 이용해서 해당 상품이 여러 개의 카테고리에 속하는 것을 표현하고 있지만 근본적인 해결책이 아니다. 
        
        RDB는 테이블이라 수직적 확장은 가능하나 수평적 확장은 불가능 하다. 
        
    6. 해결방법
        1. 매핑 테이블, 연결 테이블을 사용한다. 말 그대로 두 테이블의 중간에서 필요한 정보를 양쪽에서 끌어서 쓰는 구조이다. 
    7. 매핑 테이블의 특징
        1. 매핑 테이블의 작성 이전에 다른 테이블들이 먼저 존재해야만 한다. 
        2. 매핑 테이블은 주로 명사가 아닌 동사나 히스토리에 대한 데이터를 보관하는 용도이다.
        3. 매핑 테이블은 중간에서 양쪽의 PK를 참조하는  형태로 사용한다. 
    8. JPA에서 M:N을 처리하는 방법
        1. `@ManyToMany`를 이용해서 처리하는 방식 [[https://www.notion.so/tonyspark/6-4-52233e307ba84882b2cc0302ab21d5ff#fc2fd4c8a8094900ae975071ac9012e6](https://www.notion.so/6-4-52233e307ba84882b2cc0302ab21d5ff)]
            1. 각 엔티티와의 매핑테이블이 자동으로 생성되는 방식으로 처리 가능 
            2. 양방향 참조일때만 사용
            3. JPA의 실행에서 가장 중요한 것은 현재 메모리상(콘텍스트)의 엔티티 객체들의 상태와 데이터베이스에 상태를 동기화 
        2. 별도의 엔티티를 설계하고, `@ManyToOne`을 이용해서 처리하는 방식 [[https://www.notion.so/tonyspark/6-4-52233e307ba84882b2cc0302ab21d5ff#15d8dd1f7d0b4790a06df58fc7dd4f75](https://www.notion.so/6-4-52233e307ba84882b2cc0302ab21d5ff)]
    
2. 파일 업로드 처리 
3. 영화/리뷰 프로젝트 적용하기